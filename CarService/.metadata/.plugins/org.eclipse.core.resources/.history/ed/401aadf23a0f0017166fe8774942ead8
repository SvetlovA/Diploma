package ru.rsreu.carservice.controller.actions.orders;

import java.util.Arrays;
import java.util.Comparator;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

import javax.servlet.http.HttpServletRequest;

import ru.rsreu.carservice.model.entities.Order;
import ru.rsreu.carservice.model.entities.WorkStatus;
import ru.rsreu.carservice.model.entities.Worker;

public class OrderUtils {
	
	private static final String ORDERS_ATTRIBUTE_NAME = "orders";
	private static final String ORDERWORKSTATUS_PARAMETER_NAME = "orderworkstatus";
	private static final String ORDERTOTALCOST_PARAMETER_NAME = "ordertotalcost";
	private static final String ORDERGUID_PARAMETER_NAME = "orderguid";
	private static final String ORDERID_PARAMETER_NAME = "orderid";
	private static final String ISSELECTED_PARAMETER_NAME = "isselected";

	private OrderUtils() {
	}
	
	public static Order parseOrder(HttpServletRequest request) {
		Order order = new Order();
		int orderId = Integer.parseInt(request.getParameter(ORDERID_PARAMETER_NAME));
		order.setOrderId(orderId);
		UUID orderGuid = UUID.fromString(request.getParameter(ORDERGUID_PARAMETER_NAME));
		order.setOrderGuid(orderGuid);
		double orderTotalCost = Double.parseDouble(request.getParameter(ORDERTOTALCOST_PARAMETER_NAME));
		order.setTotalCost(orderTotalCost);
		WorkStatus orderWorkStatus = WorkStatus.valueOf(request.getParameter(ORDERWORKSTATUS_PARAMETER_NAME));
		order.setStatus(orderWorkStatus);
		return order;
	}
	
	public static void setOrder(HttpServletRequest request, Order order) {
		request.setAttribute(ORDERID_PARAMETER_NAME, order.getOrderId());
		request.setAttribute(ORDERGUID_PARAMETER_NAME, order.getOrderGuid());
		request.setAttribute(ORDERTOTALCOST_PARAMETER_NAME, order.getTotalCost());
		request.setAttribute(ORDERWORKSTATUS_PARAMETER_NAME, order.getStatus());
	}
	
	public static void setOrders(HttpServletRequest request, Set<Order> orders) {
		request.setAttribute(ORDERS_ATTRIBUTE_NAME, orders);
	}
	
	public static Set<Worker> getSelectedWorkers(Set<Worker> workers, HttpServletRequest request) {
		Set<Worker> selectedWorkers = new HashSet<Worker>();
		String[] selectedParameters = request.getParameterValues(ISSELECTED_PARAMETER_NAME);
		for (Worker worker : workers) {
			if (isSelected(selectedParameters, worker)) {
				selectedWorkers.add(worker);
			}
		}
		return selectedWorkers;
	}
	
	private static boolean isSelected(String[] selectedParameters, Worker worker) {
		int serchedIndex = Arrays.binarySearch(selectedParameters, worker.getUserGuid().toString(), new Comparator<String>() {
			@Override
			public int compare(String o1, String o2) {
				return o1.compareTo(o2);
			}
		});
		return serchedIndex > -1;
	}
}
