package ru.rsreu.carservice.controller;

import java.sql.SQLException;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpSession;
import javax.servlet.http.HttpSessionEvent;
import javax.servlet.http.HttpSessionListener;

import resources.Resourcer;
import ru.rsreu.carservice.model.bll.CarService;
import ru.rsreu.carservice.model.entities.User;

public class SessionListener implements HttpSessionListener {
	
	@Override
	public void sessionCreated(HttpSessionEvent sessionEvent) {
		setUserStatus(sessionEvent, true);
	}

	@Override
	public void sessionDestroyed(HttpSessionEvent sessionEvent) {
		setUserStatus(sessionEvent, false);
	}
	
	private void setUserStatus(HttpSessionEvent sessionEvent, boolean isOnline) {
		HttpSession session = sessionEvent.getSession();
		ServletContext context = session.getServletContext();
		CarService carService = (CarService) context.getAttribute(Resourcer.getString("parameter.carservice"));
		Object login = session.getAttribute(Resourcer.getString("parameter.user.login"));
		try {
			User user = carService.getUser(login.toString());
			user.setIsOnline(isOnline);
			carService.updateUser(user);
		} catch (SQLException e) {
			e.printStackTrace();
		}
	}
}
