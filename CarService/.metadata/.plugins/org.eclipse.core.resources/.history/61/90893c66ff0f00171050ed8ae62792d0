package ru.rsreu.carservice.controller.actions.utils;

import java.util.Arrays;
import java.util.Comparator;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

import javax.servlet.http.HttpServletRequest;

import ru.rsreu.carservice.model.entities.Work;
import ru.rsreu.carservice.model.entities.Worker;

public class WorkUtils {
	
	private static final String WORKS_ATTRIBUTE_NAME = "works";
	private static final String WORKDESCRIPTION_PARAMETER_NAME = "workdescription";
	private static final String WORKPRICE_PARAMETER_NAME = "workprice";
	private static final String WORKNAME_PARAMETER_NAME = "workname";
	private static final String WORKGUID_PARAMETER_NAME = "workguid";
	private static final String WORKID_PARAMETER_NAME = "workid";
	private static final String ISSELECTED_PARAMETER_NAME = "isselectedwork";
	
	private WorkUtils() {
	}
	
	public static Work parseWork(HttpServletRequest request) {
		Work work = new Work();
		int id = Integer.parseInt(request.getParameter(WORKID_PARAMETER_NAME));
		work.setWorkId(id);
		UUID guid = UUID.fromString(request.getParameter(WORKGUID_PARAMETER_NAME));
		work.setWorkGuid(guid);
		String name = request.getParameter(WORKNAME_PARAMETER_NAME);
		work.setName(name);
		double price = Double.parseDouble(request.getParameter(WORKPRICE_PARAMETER_NAME));
		work.setPrice(price);
		String description = request.getParameter(WORKDESCRIPTION_PARAMETER_NAME);
		work.setDescription(description);
		return work;
	}
	
	public static void setWork(HttpServletRequest request, Work work) {
		request.setAttribute(WORKID_PARAMETER_NAME, request.getParameter(WORKID_PARAMETER_NAME));
		request.setAttribute(WORKGUID_PARAMETER_NAME, request.getParameter(WORKGUID_PARAMETER_NAME));
		request.setAttribute(WORKNAME_PARAMETER_NAME, request.getParameter(WORKNAME_PARAMETER_NAME));
		request.setAttribute(WORKPRICE_PARAMETER_NAME, request.getParameter(WORKPRICE_PARAMETER_NAME));
		request.setAttribute(WORKDESCRIPTION_PARAMETER_NAME, request.getParameter(WORKDESCRIPTION_PARAMETER_NAME));
	}
	
	public static void setWorks(HttpServletRequest request, Set<Work> works) {
		request.setAttribute(WORKS_ATTRIBUTE_NAME, works);
	}
	
	public static Set<Work> getSelectedWorks(Set<Work> works, HttpServletRequest request) {
		Set<Work> selectedWorks = new HashSet<Work>();
		String[] selectedParameters = request.getParameterValues(ISSELECTED_PARAMETER_NAME);
		for (Work work : works) {
			if (isSelected(selectedParameters, work)) {
				selectedWorks.add(work);
			}
		}
		return selectedWorks;
	}
	
	private static boolean isSelected(String[] selectedParameters, Work work) {
		int serchedIndex = Arrays.binarySearch(selectedParameters, work.getWorkGuid().toString(), new Comparator<String>() {
			@Override
			public int compare(String o1, String o2) {
				return o1.compareTo(o2);
			}
		});
		return serchedIndex > -1;
	}
}
